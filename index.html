<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Tracker</title>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 100;
            min-width: 220px;
        }
        h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            font-weight: 500;
        }
        button:hover {
            background: #2563eb;
        }
        #status {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 13px;
            min-height: 20px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    
    <div id="controls">
        <h3>üåû Sun Tracker</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; display: block; margin-bottom: 5px;">City:</label>
            <select id="city-select" style="width: 100%; padding: 10px; border-radius: 6px; border: none; background: rgba(0,0,0,0.3); color: white; cursor: pointer;" onchange="changeCity()">
                <option value="47.2184,-1.5536">Nantes, France</option>
                <option value="25.2048,55.2708">Dubai, UAE üèôÔ∏è</option>
                <option value="40.7128,-74.0060">New York, USA üèôÔ∏è</option>
                <option value="1.3521,103.8198">Singapore üèôÔ∏è</option>
                <option value="22.3193,114.1694">Hong Kong üèôÔ∏è</option>
                <option value="48.8566,2.3522">Paris, France</option>
                <option value="51.5074,-0.1278">London, UK</option>
                <option value="35.6762,139.6503">Tokyo, Japan üèôÔ∏è</option>
                <option value="-33.8688,151.2093">Sydney, Australia</option>
                <option value="41.9028,12.4964">Rome, Italy</option>
                <option value="55.7558,37.6173">Moscow, Russia</option>
                <option value="34.0522,-118.2437">Los Angeles, USA</option>
                <option value="30.0444,31.2357">Cairo, Egypt</option>
                <option value="52.5200,13.4050">Berlin, Germany</option>
            </select>
        </div>
        
        <button onclick="loadBuildings()">Load Buildings</button>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 12px; margin-bottom: 8px; opacity: 0.7;">Sun Controls</div>
            <button onclick="toggleLiveSun()" id="sun-toggle">Start Live Sun</button>
            
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; display: block; margin-bottom: 5px;">Time:</label>
                <input type="time" id="time-input" style="width: 100%; padding: 8px; border-radius: 6px; border: none; background: rgba(0,0,0,0.3); color: white;" onchange="setCustomTime()">
            </div>
            
            <div id="sun-info" style="margin-top: 10px; font-size: 11px; opacity: 0.7;"></div>
        </div>
        
        <div id="status"></div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- SunCalc.js for real sun position -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    
    <!-- Your modules -->
    <script src="js/osm-parser.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/sun-manager.js"></script>

    <script>
        // Config - make it dynamic!
        let LAT = 47.2184;
        let LON = -1.5536;
        const RADIUS = 500; // Increased to 500m for better coverage

        // Initialize scene
        const sceneManager = new SceneManager('scene-container');
        let parser = new OSMParser(LAT, LON);
        
        // Initialize sun manager
        let sunManager;
        let liveSunActive = false;

        // Initialize sun manager after scene is ready
        setTimeout(() => {
            sunManager = new SunManager(LAT, LON, sceneManager);
            updateSunInfo();
            
            // Set current time in input
            const now = new Date();
            document.getElementById('time-input').value = 
                `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }, 100);

        function changeCity() {
            const select = document.getElementById('city-select');
            const coords = select.value.split(',');
            LAT = parseFloat(coords[0]);
            LON = parseFloat(coords[1]);
            
            // Update parser and sun manager with new coordinates
            parser = new OSMParser(LAT, LON);
            
            // Stop live sun if active
            if (liveSunActive && sunManager) {
                sunManager.stopLiveSun();
                liveSunActive = false;
                document.getElementById('sun-toggle').textContent = 'Start Live Sun';
            }
            
            // Recreate sun manager with new location
            sunManager = new SunManager(LAT, LON, sceneManager);
            
            // Clear existing buildings
            sceneManager.clearBuildings();
            
            // Update sun for new location
            sunManager.updateSunLight();
            updateSunInfo();
            
            // Show message
            document.getElementById('status').innerHTML = `<p style="color: #4ade80;">üìç Location changed! Click "Load Buildings" to load new area.</p>`;
            
            console.log(`Changed to: ${select.options[select.selectedIndex].text} (${LAT}, ${LON})`);
        }

        function toggleLiveSun() {
            if (!sunManager) return;
            
            const button = document.getElementById('sun-toggle');
            
            if (liveSunActive) {
                sunManager.stopLiveSun();
                button.textContent = 'Start Live Sun';
                liveSunActive = false;
            } else {
                sunManager.startLiveSun();
                button.textContent = 'Stop Live Sun';
                liveSunActive = true;
                
                // Update info every second
                setInterval(() => {
                    if (liveSunActive) updateSunInfo();
                }, 1000);
            }
        }

        function setCustomTime() {
            if (!sunManager) return;
            
            const timeInput = document.getElementById('time-input').value;
            const [hours, minutes] = timeInput.split(':').map(Number);
            
            // Stop live sun if active
            if (liveSunActive) {
                sunManager.stopLiveSun();
                document.getElementById('sun-toggle').textContent = 'Start Live Sun';
                liveSunActive = false;
            }
            
            sunManager.setTime(hours, minutes);
            updateSunInfo();
        }

        function updateSunInfo() {
            if (!sunManager) return;
            
            const times = sunManager.getSunTimes();
            const sunPos = sunManager.getSunPosition();
            
            const altitude = (sunPos.altitude * 180 / Math.PI).toFixed(1);
            const azimuth = (sunPos.azimuth * 180 / Math.PI).toFixed(1);
            
            const infoDiv = document.getElementById('sun-info');
            infoDiv.innerHTML = `
                Altitude: ${altitude}¬∞<br>
                Azimuth: ${azimuth}¬∞<br>
                Sunrise: ${times.sunrise.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}<br>
                Sunset: ${times.sunset.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}
            `;
        }

        async function loadBuildings() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p>Loading buildings...</p>';

            // Build Overpass query
            const query = `
                [out:json][timeout:25];
                (
                  way["building"](around:${RADIUS},${LAT},${LON});
                  relation["building"](around:${RADIUS},${LAT},${LON});
                );
                out body;
                >;
                out skel qt;
            `;

            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                const osmData = await response.json();
                
                console.log('Raw OSM data:', osmData);

                // Parse buildings using OSMParser
                const buildings = parser.parse(osmData);
                
                console.log('Parsed buildings:', buildings);

                // Add to scene
                sceneManager.addBuildings(buildings);

                statusDiv.innerHTML = `<p class="success">‚úÖ Loaded ${buildings.length} buildings!</p>`;

            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>